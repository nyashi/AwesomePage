<html>
<head>
	<title>Contrato de venta de alma por novia bonita</title>
        <link rel="stylesheet" type="text/css" href="contrato.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-alpha1/html2canvas.min.js"></script>
        <script>
function procesarConsulta() {
	// Obtener la cadena de consulta de la URL
	var consulta = location.search;

	// Dividir la cadena de consulta en pares clave-valor
	var pares = consulta.substring(1).split("&");

	// Crear un objeto con los pares clave-valor
	var objeto = pares.reduce(function(acumulador, par) {
		var claveValor = par.split("=");
		acumulador[claveValor[0]] = claveValor[1];
		return acumulador;
	}, {});

	// Rellenar los campos de nombre con los valores del objeto
	if (objeto.vendedor) {
		document.querySelector("#nombre-vendedor").value = objeto.vendedor;
	}
	if (objeto.comprador) {
		document.querySelector("#nombre-comprador").value = objeto.comprador;
	}
        if (objeto["firma-vendedor"]) {
		// Cargar la firma en el input
		document.querySelector("#firma_vendedor").value = objeto["firma-vendedor"];
	}
	if (objeto["firma-comprador"]) {
		// Cargar la firma en el input
		document.querySelector("#firma_comprador").value = objeto["firma-comprador"];
	}
        if (objeto["firma-vendedor-p"]) {
		// Crear una imagen con la firma
		var imgFirmaVendedor = document.createElement("img");
		imgFirmaVendedor.id = "firma_vendedor";
		imgFirmaVendedor.src = objeto["firma-vendedor-p"];

		// Reemplazar el input de la firma del vendedor por la imagen
		var inputFirmaVendedor = document.querySelector("#firma-vendedor");
		inputFirmaVendedor.parentNode.replaceChild(imgFirmaVendedor, inputFirmaVendedor);
		
	}
	if (objeto["firma-comprador-p"]) {
		// Crear una imagen con la firma
		var imgFirmaComprador = document.createElement("img");
		imgFirmaComprador.id = "firma_comprador";
		imgFirmaComprador.src = objeto["firma-comprador-p"];
		// Reemplazar el input de la firma del comprador por la imagen
		var inputFirmaComprador = document.querySelector("#firma-comprador");
		inputFirmaComprador.parentNode.replaceChild(imgFirmaComprador,inputFirmaComprador);
}
}

function dibujarFirma(id) {
	// Obtener el input y el elemento padre
	var input = document.querySelector("#" + id);
	var padre = input.parentNode;

	// Crear un elemento canvas para dibujar la firma
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext("2d");

	// Asignar el mismo ancho y alto que el input
	canvas.width = input.offsetWidth;
	canvas.height = input.offsetHeight*2;
        
	// Agregar el canvas al elemento padre y ocultar el input
	padre.replaceChild(canvas, input);
	input.style.display = "none";
        canvas.addEventListener("touchmove", function(e) {
                e.preventDefault();
		// Obtener la posición del dedo
		var x = e.targetTouches[0].pageX - canvas.offsetLeft;
		var y = e.targetTouches[0].pageY - canvas.offsetTop;
                if(dibujando){
		// Dibujar una linea desde la posición anterior hasta la posición actual del dedo
		ctx.beginPath();
		ctx.moveTo(canvas.touchX, canvas.touchY);
		ctx.lineTo(x, y);
		ctx.stroke();
                
		// Guardar la posición actual del dedo como la posición anterior para la próxima iteración
		canvas.touchX = x;
		canvas.touchY = y;
                }
	},{ passive: false });
        
         canvas.addEventListener("touchstart", function(e) {
		canvas.touchX = e.targetTouches[0].pageX - canvas.offsetLeft;
		canvas.touchY = e.targetTouches[0].pageY - canvas.offsetTop;
                dibujando=true;
	});
        canvas.addEvent("touchend",function(e){
          var dibujando=false;
        });
	// Manejar el evento mousemove del canvas para dibujar la firma
	canvas.addEventListener("mousemove", function(e) {
		// Obtener la posición del cursor
		var x = e.offsetX;
		var y = e.offsetY;

		// Dibujar una linea desde la posición anterior hasta la posición actual del cursor
		ctx.beginPath();
		ctx.moveTo(canvas.mouseX, canvas.mouseY);
		ctx.lineTo(x, y);
		ctx.stroke();

		// Guardar la posición actual del cursor como la posición anterior para la próxima iteración
		canvas.mouseX = x;
		canvas.mouseY = y;
	});

	// Manejar el evento mousedown del canvas para guardar la posición inicial del cursor
	canvas.addEventListener("mousedown", function(e) {
		canvas.mouseX = e.offsetX;
		canvas.mouseY = e.offsetY;
	});
}
</script>

</head>
<body onload="procesarConsulta();">
        <div class="contrato" id="contrato">
	<h1>Contrato de venta de alma por novia bonita</h1>
	<p>Entre yo, <input type="text" name="vendedor" id="nombre-vendedor" placeholder="nombre del vendedor">, como vendedor, y</p><p> <input type="text" name="comprador" id="nombre-comprador" placeholder="nombre del comprador">, como comprador, acordamos lo siguiente:</p>
	<ol>
		<li>Yo, el vendedor, vendo mi alma al comprador a cambio de una novia bonita.</li>
		<li>El comprador se compromete a proporcionar una novia bonita de acuerdo a sus propias definiciones de belleza.</li>
		<li>El vendedor se compromete a transferir la propiedad de su alma al comprador una vez que se haya cumplido el pago.</li>
		<li>El comprador se compromete a respetar los derechos y libertades del vendedor mientras este viva, siempre y cuando el vendedor cumpla con sus obligaciones en este contrato.</li>
		<li>El vendedor renuncia a cualquier derecho o claim sobre su alma una vez que se haya transferido la propiedad al comprador.</li>
		<li>Este contrato es válido por toda la eternidad y no puede ser revocado por ninguna de las partes involucradas.</li>
	</ol>
	<p>Firmado por ambas partes en <input type="date" name="fecha">.</p>
	<p>
		Lea nuestros <a href="#" onclick="confirm('Términos y condiciones: Este contrato es válido por toda la eternidad y no puede ser revocado por ninguna de las partes involucradas. El vendedor renuncia a cualquier derecho o claim sobre su alma una vez que se haya transferido la propiedad al comprador. El comprador se compromete a respetar los derechos y libertades del vendedor mientras este viva, siempre y cuando el vendedor cumpla con sus obligaciones en este contrato.')">términos y condiciones</a> antes de firmar.
	</p>
	<p>Firma del vendedor: <input type="text" id="firma_vendedor" name="firma_vendedor" placeholder="firma del vendedor"></p>
	<p>Firma del comprador: <input type="text" id="firma_comprador" name="firma_comprador" placeholder="firma del comprador"></p>
        </div>
        <button onclick="dibujarFirma('firma_vendedor')">Dibujar firma vendedor</button>
        <button onclick="dibujarFirma('firma_comprador')">Dibujar firma comprador</button>
        <button onclick="descargarContrato()">Descargar contrato</button>
        <button id="btn-generar-url" onclick="generarUrlCompartir()" type="button">Generar URL</button>

</body>
<script>
function generarUrlCompartir() {
	var vendedor = document.querySelector("#nombre-vendedor").value;
	var comprador = document.querySelector("#nombre-comprador").value;
	var urlCompartida = location.origin + location.pathname;
	var hayDatos = false;
	if (vendedor) {
		hayDatos = true;
		urlCompartida += "?vendedor=" + vendedor;
	}
	if (comprador) {
		if (hayDatos) {
			urlCompartida += "&";
		} else {
			urlCompartida += "?";
			hayDatos = true;
		}
		urlCompartida += "comprador=" + comprador;
	}
	var inputFirmaVendedor = document.querySelector("#firma-vendedor");
	if (inputFirmaVendedor.tagName === "INPUT") {
		var firmaVendedor = inputFirmaVendedor.value;
		if (firmaVendedor) {
			if (hayDatos) {
				urlCompartida += "&";
			} else {
				urlCompartida += "?";
				hayDatos = true;
			}
			urlCompartida += "firma-vendedor=" + firmaVendedor;
		}
	} else {
		html2canvas(inputFirmaVendedor).then(function(canvas) {
			var firmaVendedor = canvas.toDataURL();
			if (hayDatos) {
				urlCompartida += "&";
			} else {
				urlCompartida += "?";
				hayDatos = true;
			}
			urlCompartida += "firma-vendedor-p=" + firmaVendedor;
		});
	}
	var inputFirmaComprador = document.querySelector("#firma-comprador");
	if (inputFirmaComprador.tagName === "INPUT") {
		var firmaComprador = inputFirmaComprador.value;
		if (firmaComprador) {
			if (hayDatos) {
				urlCompartida += "&";
			} else {
				urlCompartida += "?";
				hayDatos = true;
			}
			urlCompartida += "firma-comprador=" + firmaComprador;
		}
	} else {
		html2canvas(inputFirmaComprador).then(function(canvas) {
			var firmaComprador = canvas.toDataURL();
			if (hayDatos) {
				urlCompartida += "&";
			} else {
				urlCompartida += "?";
				hayDatos = true;
			}
			urlCompartida += "firma-comprador-p=" + firmaComprador;
		});
       }
  alert(urlCompartida);
}
function descargarContrato() {
	// Ocultar el botón de descargar contrato
	document.querySelector("button").style.display = "none";

        
	// Recorrer todos los input del formulario y obtener su valor y elemento padre
	document.querySelectorAll("input").forEach(function(input) {
		var inp= document.querySelector("input");
                var valor=inp.value;
		var padre = inp.parentNode;

		// Crear una nueva cadena de texto que sea igual al contenido del elemento padre, reemplazando el input por su valor
		var nuevoTexto = padre.innerHTML.replace(input.outerHTML, valor);

		// Reemplazar el contenido del elemento padre por la nueva cadena de texto
		padre.innerHTML = nuevoTexto;
	});
        var canvasList = document.querySelectorAll(".contrato canvas");

	// Recorrer cada canvas y reemplazarlo por una imagen con la imagen del canvas
	canvasList.forEach(function(can) {
		// Obtener la imagen del canvas en formato base64
                var canvas=document.querySelector(".contrato canvas");
		var imagen = canvas.toDataURL();

		// Crear una imagen con el atributo src establecido con la imagen en formato base64
		var img = document.createElement("img");
		img.src = imagen;
                img.id=canvas.id;
		// Reemplazar el canvas por la imagen
		canvas.parentNode.replaceChild(img, canvas);
	});
	// Crear un elemento canvas para dibujar el contrato
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext("2d");

	// Obtener la altura y anchura del contenido del contrato
	var element = document.getElementById("contrato");
	var rect = element.getBoundingClientRect();
	canvas.width = rect.width;
	canvas.height = rect.height;

	// Dibujar el contenido del contrato en el canvas
	html2canvas(element).then(function(canvas) {
		// Mostrar el botón de descargar contrato de nuevo
		document.querySelector("button").style.display = "block";

		// Descargar la imagen del contrato
		var link = document.createElement("a");
		link.download = "contrato.png";
		link.href = canvas.toDataURL();
		link.click();
	});
}

</script>
</html>
